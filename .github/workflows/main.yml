name: OMR to MIDI Conversion

on:
  # Triggers the workflow on pushes to the 'main' branch
  push:
    branches: [ "main" ]
    paths:
      - 'scores/*.{png,jpg,jpeg,pdf}'
  # Allows you to manually run the workflow
  workflow_dispatch:

jobs:
  convert_score:
    runs-on: ubuntu-latest
    
    env:
      INPUT_DIR: scores
      OUTPUT_DIR: music_data

    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4
        
      - name: ‚öôÔ∏è Set Up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: üì¶ Install Python Dependencies
        run: pip install -r requirements.txt

      - name: üßπ Create Output Directory and Input List
        run: |
          mkdir -p ${{ env.OUTPUT_DIR }}
          # Create a file list using the correct path /input/score.png format
          find ${{ env.INPUT_DIR }} -type f -regex ".*\.\(png\|jpg\|jpeg\|pdf\)" -printf '/input/%f\n' > input_files.txt
          
          # Exit if no input files are found
          if ! [ -s input_files.txt ]; then
            echo "::warning::No score files found in 'scores/'. Skipping OMR step."
            exit 0
          fi
          echo "Found scores to process."

      - name: üéµ Run Audiveris (OMR to MusicXML) via Docker CLI 
        # FINAL COMMAND: Accessible image, memory fixed, export forced.
        run: |
          echo "Starting OMR process using Audiveris Docker (toprock, high memory, forcing export)..."
          docker run --rm \
            -v ${{ github.workspace }}/${{ env.INPUT_DIR }}:/input \
            -v ${{ github.workspace }}/${{ env.OUTPUT_DIR }}:/output \
            -v ${{ github.workspace }}/input_files.txt:/tmp/input_files.txt \
            -e JAVA_TOOL_OPTIONS='-Xmx4g' \
            toprock/audiveris:latest \
            /audiveris-extract/bin/Audiveris \
            -batch \
            -output /output \
            -export \
            @/tmp/input_files.txt
          echo "Audiveris OMR complete."

      - name: üìù Display Audiveris Error Log
        # Displays the log file for diagnosis if OMR failed.
        run: |
          echo "Attempting to find and display the Audiveris log file for error diagnosis..."
          # Find the first file ending in .log recursively inside the output directory
          LOG_FILE=$(find ${{ env.OUTPUT_DIR }} -name "*.log" -print -quit 2>/dev/null | head -n 1)
          
          if [ -f "$LOG_FILE" ]; then
            echo "--- Contents of Audiveris Log File ($LOG_FILE) ---"
            cat "$LOG_FILE"
            echo "----------------------------------------------------"
          else
            echo "::warning::Audiveris log file not found. Skipping log display."
          fi

      - name: üîé Verify Audiveris Output
        # Checks for the essential .mxl file before conversion.
        run: |
          echo "Listing contents of ${{ env.OUTPUT_DIR }} after Audiveris run (recursive check):"
          ls -R ${{ env.OUTPUT_DIR }}
          
          if [ -z "$(find ${{ env.OUTPUT_DIR }} -name "*.mxl" -print -quit 2>/dev/null)" ]; then
            echo "::error::Audiveris failed to generate any MusicXML (.mxl) files. Please check the log files above."
            exit 1 # Fail the job here if no MXL is found
          else
            echo "‚úÖ MusicXML files found! Proceeding to MIDI conversion."
          fi

      - name: üéº Run MusicXML to MIDI Conversion (Python)
        # Converts all found .mxl files to .mid files.
        run: |
          echo "Starting MusicXML to MIDI conversion..."
          find ${{ env.OUTPUT_DIR }} -name "*.mxl" | while read XML_FILE; do
            if [ -f "$XML_FILE" ]; then
              echo "Converting $XML_FILE to MIDI..."
              python scripts/xml_to_midi.py "$XML_FILE"
            fi
          done
          echo "Conversion complete."

      - name: ‚¨ÜÔ∏è Upload Generated MIDI/XML Files (as Artifact)
        # Uploads all contents of the output directory (including the final .mid file)
        uses: actions/upload-artifact@v4
        with:
          name: converted-music-files
          path: ${{ env.OUTPUT_DIR }}
          retention-days: 7
          
      # The commit step has been completely removed.
